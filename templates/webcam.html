<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Webcam Recognition</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    video { width: 640px; max-width: 100%; border: 1px solid #ccc; }
    canvas { display:none; }
  </style>
</head>
<body>
  <div class="container">
    <h2>Webcam â€” Snapshot Recognition</h2>
    <p>Click Start to allow webcam. App will take a snapshot every 1 second and send to server for recognition (you can stop anytime).</p>
    <video id="video" autoplay playsinline></video>
    <br>
    <button id="start">Start</button>
    <button id="stop" disabled>Stop</button>
    <div id="log" style="margin-top:12px;"></div>
    <canvas id="canvas"></canvas>

    <p><a href="{{ url_for('index') }}">Home</a></p>
  </div>

<script>
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const startBtn = document.getElementById('start');
const stopBtn = document.getElementById('stop');
const log = document.getElementById('log');
let stream = null;
let intervalId = null;

startBtn.onclick = async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: false });
    video.srcObject = stream;
    startBtn.disabled = true;
    stopBtn.disabled = false;
    canvas.width = 640;
    canvas.height = 480;
    intervalId = setInterval(takeAndSendSnapshot, 1000);
  } catch (e) {
    alert("Could not access camera: " + e.message);
  }
};

stopBtn.onclick = () => {
  startBtn.disabled = false;
  stopBtn.disabled = true;
  clearInterval(intervalId);
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
    stream = null;
  }
};

async function takeAndSendSnapshot() {
  const ctx = canvas.getContext('2d');
  ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
  const dataUrl = canvas.toDataURL('image/jpeg', 0.8);
  try {
    const res = await fetch('{{ url_for("recognize_webcam") }}', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ image: dataUrl })
    });
    const json = await res.json();
    if (json.status === 'ok') {
      const names = json.results.map(r => r.name + (r.distance ? ` (${r.distance.toFixed(2)})` : '')).join(', ');
      log.innerHTML = `<div class="card">Detected: ${names}</div>`;
    } else {
      log.innerHTML = `<div class="card">${json.message || JSON.stringify(json)}</div>`;
    }
  } catch (err) {
    console.error(err);
    log.innerHTML = `<div class="card">Error: ${err.message}</div>`;
  }
}
</script>
</body>
</html>
